

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fusionbox.forms.forms &mdash; django-fusionbox v0.0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="django-fusionbox v0.0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">django-fusionbox v0.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for fusionbox.forms.forms</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">urllib</span>

<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>


<span class="k">class</span> <span class="nc">IterDict</span><span class="p">(</span><span class="n">SortedDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension of djangos built in sorted dictionary class which iterates</span>
<span class="sd">    through the values rather than keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">BaseChangeListForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseChangeListForm"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.BaseChangeListForm">[docs]</a><span class="sd">    Base class for all `ChangeListForms`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_css_class</span> <span class="o">=</span> <span class="s">&#39;error&#39;</span>
    <span class="n">required_css_class</span> <span class="o">=</span> <span class="s">&#39;required&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes an option named argument `queryset` as the base queryset used in</span>
<span class="sd">        the `get_queryset` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;queryset&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseChangeListForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseChangeListForm.get_queryset"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.BaseChangeListForm.get_queryset">[docs]</a><span class="sd">        If the form was initialized with a queryset, this method returns that</span>
<span class="sd">        queryset.  Otherwise it returns `Model.objects.all()` for whatever</span>
<span class="sd">        model was defined for the form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span>


<span class="k">class</span> <span class="nc">SearchForm</span><span class="p">(</span><span class="n">BaseChangeListForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div></div>
<div class="viewcode-block" id="SearchForm"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SearchForm">[docs]</a><span class="sd">    Base form class for implementing searching on a model.</span>

<span class="sd">    # Example Usage</span>

<span class="sd">        class UserSearchForm(SearchForm):</span>
<span class="sd">            SEARCH_FIELDS = (&#39;username&#39;, &#39;email&#39;, &#39;profile__role&#39;)</span>
<span class="sd">            model = User</span>

<span class="sd">        &gt;&gt;&gt; form = UserSearchForm(request.GET, queryset=User.objects.filter(is_active=True))</span>
<span class="sd">        &gt;&gt;&gt; form</span>
<span class="sd">        &lt;accounts.forms.UserSearchForm object at 0x102ea18d0&gt;</span>
<span class="sd">        &gt;&gt;&gt; form.get_queryset()</span>
<span class="sd">        [&lt;User: admin&gt;, &lt;User: test@test.com&gt;, &lt;User: test2@test.com&gt;]</span>

<span class="sd">    `SEARCH_FIELDS` should be an iterable of valid django queryset field lookups.</span>
<span class="sd">    Lookups can span foreign key relationships.</span>

<span class="sd">    By default, searches will be case insensitive.  Set `CASE_SENSITIVE` to</span>
<span class="sd">    `True` to make searches case sensitive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SEARCH_FIELDS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">CASE_SENSITIVE</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;Search&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SearchForm.pre_search"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SearchForm.pre_search">[docs]</a><span class="sd">        Hook for modifying the queryset prior to the search</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">post_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="SearchForm.post_search"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SearchForm.post_search">[docs]</a><span class="sd">        Hook for modifying the queryset after the search.  Will not be called</span>
<span class="sd">        on an invalid form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="SearchForm.get_queryset"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SearchForm.get_queryset">[docs]</a><span class="sd">        Constructs an &#39;__contains&#39; or &#39;__icontains&#39; filter across all of the</span>
<span class="sd">        fields listed in `SEARCH_FIELDS`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SearchForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_search</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="c"># Ensure that the form is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="c"># Do Searching</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;q&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SEARCH_FIELDS</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASE_SENSITIVE</span><span class="p">:</span>
                    <span class="n">kwarg</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="o">+</span> <span class="s">&#39;__contains&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwarg</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="o">+</span> <span class="s">&#39;__icontains&#39;</span><span class="p">:</span> <span class="n">q</span><span class="p">}</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="o">**</span><span class="n">kwarg</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">|</span> <span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_search</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qs</span>


<span class="k">class</span> <span class="nc">SortForm</span><span class="p">(</span><span class="n">BaseChangeListForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div></div>
<div class="viewcode-block" id="SortForm"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SortForm">[docs]</a><span class="sd">    Base class for implementing sorting on a model.</span>

<span class="sd">    # Example Usage</span>

<span class="sd">    class UserSortForm(SortForm):</span>
<span class="sd">        HEADERS = (</span>
<span class="sd">            {&#39;column&#39;: &#39;username&#39;, &#39;title&#39;: &#39;Username&#39;, &#39;sortable&#39;: True},</span>
<span class="sd">            {&#39;column&#39;: &#39;email&#39;, &#39;title&#39;: &#39;Email Address&#39;, &#39;sortable&#39;: True},</span>
<span class="sd">            {&#39;column&#39;: &#39;is_active&#39;, &#39;title&#39;: &#39;Active&#39;, &#39;sortable&#39;: False},</span>
<span class="sd">        model = User</span>

<span class="sd">    The sort field for this form defaults to a HiddenInput widget which should</span>
<span class="sd">    be output within your form to preserve sorting accross any form</span>
<span class="sd">    submissions.</span>

<span class="sd">    From within your template, this form gives access to very useful methods</span>
<span class="sd">    for producing table headers and links for progressive or singular</span>
<span class="sd">    searching.</span>

<span class="sd">    {{ form.headers }}</span>
<span class="sd">        - iterable of headers</span>

<span class="sd">    {{ header.title }}</span>
<span class="sd">        - title declared for this header</span>

<span class="sd">    {{ header.sortable }}</span>
<span class="sd">        - boolean for whether this header is sortable</span>

<span class="sd">    {{ header.active }}</span>
<span class="sd">        - boolean for whether the queryset is currently being sorted by this header</span>

<span class="sd">    {{ header.classes }}</span>
<span class="sd">        - list of css classes for this header. (active, ascending|descending)</span>

<span class="sd">    {{ header.priority }}</span>
<span class="sd">        - numeric index for which place this header is being used for ordering.</span>

<span class="sd">    {{ header.querystring }}</span>
<span class="sd">        - querystring for use with progressive sorting (sorting by multiple fields)</span>

<span class="sd">    {{ header.remove }}</span>
<span class="sd">        - querystring which can be used to remove this header from sorting</span>

<span class="sd">    {{ header.singular }}</span>
<span class="sd">        - querystring which can be used to sort only by this header</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HEADERS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">HiddenInput</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">clean_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cleaned_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="n">sorts</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">sorts</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">sorts</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sorts</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c"># Ensure that the sort parameter does not contain non-numeric sort indexes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">sort</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Unknown or invalid sort &#39;{sort}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)))</span>
        <span class="n">sorts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">]</span>
        <span class="c"># Ensure not un-sortable fields are being sorted by</span>
        <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">abs</span><span class="p">,</span> <span class="n">sorts</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HEADERS</span><span class="p">[</span><span class="n">sort</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;sortable&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Invalid sort parameter &#39;{sort}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)))</span>
        <span class="c"># Ensure that all of our sort parameters are in range of our header values</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HEADERS</span><span class="p">)</span> <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Invalid sort parameter &#39;{sort}&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">sorts</span>

    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="SortForm.headers"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SortForm.headers">[docs]</a><span class="sd">        Access to the headers template object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">IterDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">sorts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sorts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="c">#for index, column, title, sortable in self.SORT_CHOICES:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HEADERS</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s">&#39;classes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;sortable&#39;</span><span class="p">]:</span>
                <span class="c"># compute sort parameter</span>
                <span class="k">if</span> <span class="n">sorts</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">sorts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">index</span><span class="p">:</span>
                    <span class="n">header_sorts</span> <span class="o">=</span> <span class="p">[</span><span class="n">sorts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sorts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">header_sorts</span> <span class="o">=</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">index</span><span class="p">,</span> <span class="n">sorts</span><span class="p">)</span>

                <span class="c"># handles form prefixing on querystring parameters</span>
                <span class="n">sort_param</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-sort&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>

                <span class="c"># Progressive sort querystring</span>
                <span class="n">params</span><span class="p">[</span><span class="n">sort_param</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">header_sorts</span><span class="p">))</span>
                <span class="n">header</span><span class="p">[</span><span class="s">&#39;querystring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="c"># Single sort querystring</span>
                <span class="n">params</span><span class="p">[</span><span class="n">sort_param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="n">header</span><span class="p">[</span><span class="s">&#39;singular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="c"># Remove sort querystring</span>
                <span class="n">params</span><span class="p">[</span><span class="n">sort_param</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">header_sorts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
                <span class="n">header</span><span class="p">[</span><span class="s">&#39;remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

                <span class="c"># set sort priority display</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">header</span><span class="p">[</span><span class="s">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">abs</span><span class="p">,</span> <span class="n">sorts</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">header</span><span class="p">[</span><span class="s">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;active&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;ascending&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">header</span><span class="p">[</span><span class="s">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;descending&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">header</span><span class="p">[</span><span class="s">&#39;priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c">#headers.append(header)</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;column&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="k">return</span> <span class="n">headers</span>

    <span class="k">def</span> <span class="nf">pre_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="SortForm.pre_sort"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SortForm.pre_sort">[docs]</a><span class="sd">        Hook for doing pre-sort modification of the queryset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">post_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="SortForm.post_sort"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SortForm.post_sort">[docs]</a><span class="sd">        Hook for doing post-sort modification of the queryset.  Will not be</span>
<span class="sd">        called on an invalid form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="SortForm.get_queryset"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.SortForm.get_queryset">[docs]</a><span class="sd">        Returns an ordered queryset, sorted based on the values submitted in</span>
<span class="sd">        the sort parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SortForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_sort</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="c"># Ensure that the form is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="c"># Do Sorting</span>
        <span class="n">sorts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;sort&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sort</span> <span class="ow">in</span> <span class="n">sorts</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HEADERS</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s">&#39;column&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sort</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">param</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">param</span>
            <span class="n">order_by</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">order_by</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="o">*</span><span class="n">order_by</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_sort</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qs</span>


<span class="k">class</span> <span class="nc">FilterForm</span><span class="p">(</span><span class="n">BaseChangeListForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div></div>
<div class="viewcode-block" id="FilterForm"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.FilterForm">[docs]</a><span class="sd">    Base class for implementing filtering on a model.</span>

<span class="sd">    # Example Usage</span>

<span class="sd">    class UserFilterForm(FilterForm):</span>
<span class="sd">        FILTERS = {</span>
<span class="sd">            &#39;active&#39;: &#39;is_active&#39;,</span>
<span class="sd">            &#39;date_joined&#39;: &#39;date_joined__gte&#39;,</span>
<span class="sd">            &#39;published&#39;: None, # Custom filtering</span>
<span class="sd">            }</span>
<span class="sd">        model = User</span>

<span class="sd">        PUBLISHED_CHOICES = (</span>
<span class="sd">                (&#39;&#39;, &#39;All&#39;),</span>
<span class="sd">                (&#39;before&#39;, &#39;Before Today&#39;),</span>
<span class="sd">                (&#39;after&#39;, &#39;After Today&#39;),</span>
<span class="sd">                )</span>

<span class="sd">        active = forms.BooleanField(required=False)</span>
<span class="sd">        date_joined = forms.DateTimeField(required=False)</span>
<span class="sd">        published = forms.ChoiceField(choices=PUBLISHED_CHOICES, widget=forms.HiddenInput())</span>

<span class="sd">        def pre_filter(self, queryset):</span>
<span class="sd">            published = self.cleaned_data.get(&#39;published&#39;)</span>
<span class="sd">            if published == &#39;&#39;:</span>
<span class="sd">                return queryset</span>
<span class="sd">            elif published == &#39;before&#39;:</span>
<span class="sd">                return queryset.filter(published_at__lte=datetime.datetime.now())</span>
<span class="sd">            elif published == &#39;after&#39;:</span>
<span class="sd">                return queryset.filter(published_at__gte=datetime.datetime.now())</span>


<span class="sd">    `FILTERS` defines a mapping of form fields to queryset filters.</span>

<span class="sd">    When displaying in the template, this form also provides you with url querystrings for all of your filters.</span>

<span class="sd">    `form.filters` is a dictionary of all of the filters defined on your form.</span>

<span class="sd">    In the example above, you could do the following in the template for display links for the published filter</span>

<span class="sd">    {% for choice in form.filters.published %}</span>
<span class="sd">        {% if choice.active %}</span>
<span class="sd">            {{ choice.display }} (&lt;a href=&#39;?{{ choice.remove }}&#39;&gt;remove&lt;/a&gt;)</span>
<span class="sd">        {% else %}</span>
<span class="sd">            &lt;a href=&#39;?{{ choice.querystring }}&#39;&gt;{{ choice.display }}&lt;/a&gt;</span>
<span class="sd">        {% endif %}</span>
<span class="sd">    {% endfor %}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FILTERS</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="FilterForm.filters"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.FilterForm.filters">[docs]</a><span class="sd">        Generates a dictionary of filters with proper queryset links to</span>
<span class="sd">        maintian multiple filters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">IterDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILTERS</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="n">IterDict</span><span class="p">()</span>
            <span class="n">filter_param</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">display</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">choice</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">choice</span><span class="p">[</span><span class="s">&#39;display&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">display</span>

                <span class="c"># These are raw values so they must come from data, and be</span>
                <span class="c"># coerced to strings</span>
                <span class="n">choice</span><span class="p">[</span><span class="s">&#39;active&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">filter_param</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

                <span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="c"># Filter by this current choice</span>
                <span class="n">params</span><span class="p">[</span><span class="n">filter_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">choice</span><span class="p">[</span><span class="s">&#39;querystring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
                <span class="c"># remove this filter</span>
                <span class="n">params</span><span class="p">[</span><span class="n">filter_param</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">choice</span><span class="p">[</span><span class="s">&#39;remove&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

                <span class="nb">filter</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="n">choice</span>
            <span class="n">filters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span>
        <span class="k">return</span> <span class="n">filters</span>

    <span class="k">def</span> <span class="nf">pre_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="FilterForm.pre_filter"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.FilterForm.pre_filter">[docs]</a><span class="sd">        Hook for doing pre-filter modification to the queryset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">post_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span></div>
<div class="viewcode-block" id="FilterForm.post_filter"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.FilterForm.post_filter">[docs]</a><span class="sd">        Hook for doing post-filter modification to the queryset.  This is also</span>
<span class="sd">        the place where any custom filtering should take place.  Will not be</span>
<span class="sd">        called on an invalid form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">qs</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">FilterForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span></div>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_filter</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="c">#  Ensure that the form is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">qs</span>

        <span class="c"># Do filtering</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">column_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILTERS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">column_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">column_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="n">field</span><span class="p">]})</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_filter</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qs</span>


<span class="k">def</span> <span class="nf">csv_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span></div>
<span class="sd">    Helper function for CsvForm class that gets an attribute from a model with</span>
<span class="sd">    a custom exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;CsvForm: No </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> attribute found on </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s"> object&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">attr_name</span><span class="p">,</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
            <span class="p">))</span>


<span class="k">def</span> <span class="nf">csv_getvalue</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function for CsvForm class that retrieves a value from an object</span>
<span class="sd">    described by a django-style query path.  The value can be a model field,</span>
<span class="sd">    property method, foreign key field, or instance method on the model.</span>

<span class="sd">    Example:</span>
<span class="sd">    &gt;&gt;&gt; # full_name is a property method</span>
<span class="sd">    &gt;&gt;&gt; csv_getvalue(instance, &#39;project__employee__full_name&#39;)</span>
<span class="sd">    u&#39;David Sanders&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">attr_name</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># Record object is empty, return None</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c"># Return the last leaf of the path after evaluation</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">csv_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="c"># Attribute is a model instance.  Return unicode.</span>
            <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="c"># Attribute is a callable method.  Return its value when called.</span>
            <span class="k">return</span> <span class="n">attr</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Otherwise, assume attr is a simple value</span>
            <span class="k">return</span> <span class="n">attr</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c"># More of path is remaining to be traversed</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">csv_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="c"># If attribute is a model instance, traverse into it</span>
            <span class="k">return</span> <span class="n">csv_getvalue</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&#39;CsvForm: Attribute </span><span class="se">\&#39;</span><span class="s">{0}</span><span class="se">\&#39;</span><span class="s"> on object </span><span class="se">\&#39;</span><span class="s">{1}</span><span class="se">\&#39;</span><span class="s"> is not a related model&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">attr_name</span><span class="p">,</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                <span class="p">))</span>


<span class="k">class</span> <span class="nc">CsvForm</span><span class="p">(</span><span class="n">BaseChangeListForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CsvForm"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.CsvForm">[docs]</a><span class="sd">    Base class for implementing csv generation on a model.</span>

<span class="sd">    Example:</span>

<span class="sd">    # Given this class...</span>
<span class="sd">    class UserFilterForm(FilterForm):</span>
<span class="sd">        model = User</span>

<span class="sd">        CSV_COLUMNS = (</span>
<span class="sd">                {&#39;column&#39;: &#39;id&#39;, &#39;title&#39;: &#39;Id&#39;},</span>
<span class="sd">                {&#39;column&#39;: &#39;username&#39;, &#39;title&#39;: &#39;Username&#39;},</span>
<span class="sd">                {&#39;column&#39;: &#39;email__domain_name&#39;, &#39;title&#39;: &#39;Email Domain&#39;},</span>
<span class="sd">                )</span>

<span class="sd">        FILTERS = {</span>
<span class="sd">            &#39;active&#39;: &#39;is_active&#39;,</span>
<span class="sd">            &#39;date_joined&#39;: &#39;date_joined__gte&#39;,</span>
<span class="sd">            &#39;published&#39;: None, # Custom filtering</span>
<span class="sd">            }</span>

<span class="sd">        PUBLISHED_CHOICES = (</span>
<span class="sd">                (&#39;&#39;, &#39;All&#39;),</span>
<span class="sd">                (&#39;before&#39;, &#39;Before Today&#39;),</span>
<span class="sd">                (&#39;after&#39;, &#39;After Today&#39;),</span>
<span class="sd">                )</span>

<span class="sd">        active = forms.BooleanField(required=False)</span>
<span class="sd">        date_joined = forms.DateTimeField(required=False)</span>
<span class="sd">        published = forms.ChoiceField(choices=PUBLISHED_CHOICES, widget=forms.HiddenInput())</span>

<span class="sd">        def pre_filter(self, queryset):</span>
<span class="sd">            published = self.cleaned_data.get(&#39;published&#39;)</span>
<span class="sd">            if published == &#39;&#39;:</span>
<span class="sd">                return queryset</span>
<span class="sd">            elif published == &#39;before&#39;:</span>
<span class="sd">                return queryset.filter(published_at__lte=datetime.datetime.now())</span>
<span class="sd">            elif published == &#39;after&#39;:</span>
<span class="sd">                return queryset.filter(published_at__gte=datetime.datetime.now())</span>


<span class="sd">    &gt;&gt;&gt; # This code in a repl will produce a string buffer with csv output for</span>
<span class="sd">    &gt;&gt;&gt; # the form&#39;s queryset</span>
<span class="sd">    &gt;&gt;&gt; form = UserFilterForm(request.GET, queryset=User.objects.all())</span>
<span class="sd">    &gt;&gt;&gt; form.csv_content()</span>
<span class="sd">    &lt;StringIO.StringO object at 0x102fd2f48&gt;</span>
<span class="sd">    &gt;&gt;&gt;</span>


<span class="sd">    `CSV_COLUMNS` defines a list of properties to fetch from each obj in the</span>
<span class="sd">    queryset which will be output in the csv content.  The `column` key defines</span>
<span class="sd">    the lookup path for the property.  This can lookup a field, property</span>
<span class="sd">    method, or method on the model which may span relationships.  The `title`</span>
<span class="sd">    key defines the column header to use for that property in the csv content.</span>

<span class="sd">    The `csv_content` method returns a string buffer with csv content for the</span>
<span class="sd">    form&#39;s queryset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">csv_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="CsvForm.csv_content"><a class="viewcode-back" href="../../../forms.html#fusionbox.forms.forms.CsvForm.csv_content">[docs]</a><span class="sd">        Returns the objects in the form&#39;s current queryset as csv content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;CSV_COLUMNS&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;Child classes of CsvForm must implement the CSV_COLUMNS constant&#39;</span><span class="p">)</span>

        <span class="c"># Get column fields and headers</span>
        <span class="n">csv_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;column&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CSV_COLUMNS</span><span class="p">]</span>
        <span class="n">csv_headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CSV_COLUMNS</span><span class="p">]</span>

        <span class="c"># Build data for csv writer</span>
        <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">():</span>
            <span class="n">csv_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="n">csv_getvalue</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">csv_columns</span><span class="p">])</span>

        <span class="c"># Create buffer with csv content</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">csv_headers</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">csv_data</span><span class="p">)</span>
        <span class="n">content</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">content</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">django-fusionbox v0.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Fusionbox.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>